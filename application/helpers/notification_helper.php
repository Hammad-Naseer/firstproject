<?php    function sendNotificationByUserId($device_id, $title, $message, $link , $userId , $userTypeId){                $CI =& get_instance();        $CI->load->database();                if($userTypeId == 1){            $type = "admin";        }        else if($userTypeId == 3){            $type = "teacher";        }        else if($userTypeId == 4){            $type = "parent";        }        else if($userTypeId == 6){            $type = "student";        }                $school_id = $_SESSION['school_id'];        $data_not = array(            'user_id'     => $userId ,            'user_type'   => $type,            'url'         => $link ,            'inserted_at' => date('Y-m-d, h:i:s'),            'text'        => $message ,            'is_viewed'   => 0,            'school_id'   => $school_id        ); 	    $CI->db->insert(get_school_db().".school_notifications" , $data_not);                        if(!empty($device_id)){                        $app_id = 'c0c462a2-13b1-4dc9-a93c-d45b65c10b55';            $content = array( "en" => $message );            $hases_array = array();            array_push($hases_array , array(                "id"    =>  "like-button-2",                "text"  =>  "INDICI EDU",                "icon"  =>  "//lh3.googleusercontent.com/a-/AAuE7mDiEeRlIcdqvPPR5xRIGMgnh7Z1RIz0O0xhWWeoyw=s88",                "url"   =>  $link            ));            $headings = array( 'en' => $title );            $fields = array(                'app_id' => $app_id,                'include_player_ids' => array($device_id),                'data' => array("foo" => "bar"),                'contents' => $content,                'headings' => $headings,                'web_buttons'=>$hases_array,                'url' => $link            );                $fields = json_encode($fields);            $ch = curl_init();            curl_setopt($ch, CURLOPT_URL, "https://onesignal.com/api/v1/notifications");            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json; charset=utf-8'));            curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);            curl_setopt($ch, CURLOPT_HEADER, FALSE);            curl_setopt($ch, CURLOPT_POST, TRUE);            curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);            $response = curl_exec($ch);            curl_close($ch);            return $response;                    }                    }        function get_user_device_id($user_type , $user_id , $d_school_id="")    {              $CI =& get_instance();        $CI->load->database();                $school_id = "";        if (!empty($d_school_id)) {            $school_id = $d_school_id;        } else {            $school_id = $_SESSION['school_id'];        }                $filter = "";        if($user_type == 1){            $filter =   "where admin_id  ";        }elseif($user_type == 3){            $filter =   "where teacher_id  ";        }elseif($user_type == 4){            $filter =   "where parent_id  ";        }elseif($user_type == 6){            $filter =   "where student_id  ";        }                if($filter != ""){              $device_id = $CI->db->query("select device_id from " . get_system_db() . ".user_devices ".$filter." = $user_id AND school_id=" . $school_id . "")->row();                       if($device_id != null){                  return $device_id->device_id;              }              else              {                  return "";              }             }        else        {              return "";        }    }            function get_school_admins(){        $CI =& get_instance();        $CI->load->database();        $query= "select user_login_detail_id from " . get_system_db() . ".user_login_details where login_type = 1 and sys_sch_id=" . $_SESSION['school_id'] . "";        $users = $CI->db->query($query)->result_array();        return $users;    }        function get_user_notifications($user_id , $user_type){        $CI =& get_instance();        $CI->load->database();                $school_id = $_SESSION['school_id'];        if($user_type != 'parent'){            $query= "select * from " . get_school_db() . ".school_notifications where user_id = $user_id and school_id = $school_id and user_type='$user_type' and is_viewed = 0 order by id desc";        }        else        {                /*           	            $query_relation = $CI->db->query("SELECT GROUP_CONCAT(s.student_id) as student_ids                                        	FROM ".get_school_db().".student_parent sp                                        	INNER JOIN ".get_school_db().".student_relation sr ON sr.s_p_id = sp.s_p_id                                        	INNER JOIN ".get_school_db().".student s ON s.student_id=sr.student_id                                        	INNER JOIN ".get_school_db().".class_section cs ON cs.section_id=s.section_id                                        	INNER JOIN ".get_school_db().".class c ON c.class_id=cs.class_id                                        	INNER JOIN ".get_school_db().".departments dep ON dep.departments_id=c.departments_id                                         	WHERE                                          	s.student_status IN (".student_query_status().")                                        	and sp.school_id=".$_SESSION['school_id']."                                         	AND sp.user_login_detail_id=".$_SESSION['login_detail_id'])->row();                        $student_ids =   $query_relation->student_ids;              $query= "select * from " . get_school_db() . ".school_notifications where user_id in ($student_ids) and school_id = $school_id and user_type='student' and is_viewed = 0 order by id desc";            */             $query= "select * from " . get_school_db() . ".school_notifications where user_id = $user_id and school_id = $school_id and user_type='$user_type' and is_viewed = 0 order by id desc";        }                $nots = $CI->db->query($query)->result_array();        return $nots;            }    function get_user_all_notifications($user_id , $user_type){        $CI =& get_instance();        $CI->load->database();                $school_id = $_SESSION['school_id'];        if($user_type != 'parent'){            $query= "select * from " . get_school_db() . ".school_notifications where user_id = $user_id and school_id = $school_id and user_type='$user_type' and is_viewed = 1 order by id desc";        }        else        {                /*           	            $query_relation = $CI->db->query("SELECT GROUP_CONCAT(s.student_id) as student_ids                                        	FROM ".get_school_db().".student_parent sp                                        	INNER JOIN ".get_school_db().".student_relation sr ON sr.s_p_id = sp.s_p_id                                        	INNER JOIN ".get_school_db().".student s ON s.student_id=sr.student_id                                        	INNER JOIN ".get_school_db().".class_section cs ON cs.section_id=s.section_id                                        	INNER JOIN ".get_school_db().".class c ON c.class_id=cs.class_id                                        	INNER JOIN ".get_school_db().".departments dep ON dep.departments_id=c.departments_id                                         	WHERE                                          	s.student_status IN (".student_query_status().")                                        	and sp.school_id=".$_SESSION['school_id']."                                         	AND sp.user_login_detail_id=".$_SESSION['login_detail_id'])->row();                        $student_ids =   $query_relation->student_ids;              $query= "select * from " . get_school_db() . ".school_notifications where user_id in ($student_ids) and school_id = $school_id and user_type='student' and is_viewed = 0 order by id desc";            */             $query= "select * from " . get_school_db() . ".school_notifications where user_id = $user_id and school_id = $school_id and user_type='$user_type' and is_viewed = 1 order by id desc";        }                $nots = $CI->db->query($query)->result_array();        return $nots;            }        function get_school_teachers(){        $CI =& get_instance();        $CI->load->database();        $users = $CI->db->query("select user_login_detail_id from " . get_system_db() . ".user_login_details where login_type = 3 and sys_sch_id=" . $_SESSION['school_id'] . "")->result_array();        return $users;    }    ?>