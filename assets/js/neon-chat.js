var neonChat=neonChat||{$current_user:null,isOpen:!1,chat_history:[],statuses:{online:{class:"is-online",order:1,label:"Online"},offline:{class:"is-offline",order:4,label:"Offline"},idle:{class:"is-idle",order:3,label:"Idle"},busy:{class:"is-busy",order:2,label:"Busy"}}};!function(a,s,t){"use strict";var e=a("#chat"),n=e.find(".chat-inner"),r=e.find(".badge").add(a(".chat-notifications-badge")),i=e.find(".chat-conversation"),o=i.find(".conversation-header"),d=i.find(".conversation-body"),h=i.find(".chat-textarea textarea"),u=!a(".page-container").hasClass("sidebar-collapsed");a.extend(neonChat,{init:function(){i.on("click",".conversation-close",neonChat.close),a("body").on("click",".chat-close",function(s){s.preventDefault();var t=a(this).is("[data-animate]");neonChat.hideChat(t)}),a("body").on("click",".chat-open",function(s){s.preventDefault();var t=a(this).is("[data-animate]");neonChat.showChat(t)}),h.keydown(function(a){if(13==a.keyCode&&!a.shiftKey)return a.preventDefault(),neonChat.submitMessage(),!1;27==a.keyCode&&neonChat.close()}),e.on("click",".chat-group a",function(s){s.preventDefault();var t=a(this);t.hasClass("active")?neonChat.close():neonChat.open(t)}),e.find(".chat-group a").each(function(s,t){a(t).append('<span class="badge badge-info is-hidden">0</span>')}),neonChat.refreshUserIds(),neonChat.orderGroups(),neonChat.prefetchMessages(),neonChat.countUnreadMessages(),neonChat.puffUnreads(),e.hasClass("fixed")&&n.length&&a.isFunction(a.fn.niceScroll)&&e.find(".chat-inner").niceScroll({cursorcolor:"#454a54",cursorborder:"1px solid #454a54",railpadding:{right:3},railalign:"right",cursorborderradius:1}),a("body").on("click",'[data-toggle="chat"]',function(s){s.preventDefault();var t=a(this),e=t.is("[data-animate]"),n=t.is("[data-collapse-sidebar]");neonChat.toggleChat(e,n)})},open:function(s){this.refreshUserIds(),"string"==typeof s&&(s=a(s)),e.find(".chat-group a").not(s).removeClass("active"),s.addClass("active");var t=this.statuses[this.chat_history[s.attr("id")].status];o.find(".display-name").html(s.find("em").text()),t&&(o.find(".user-status").attr("class","user-status "+t.class),o.find("small").html(t.label)),i.show(),h.val(""),this.updateScrollbars(),this.updateConversationOffset(s),h.focus(),this.$current_user=s,this.isOpen=!0,this.renderMessages(this.$current_user.attr("id")),this.resetUnreads(this.$current_user.attr("id")),this.puffUnreadsAll()},close:function(){return e.find(".chat-group a").removeClass("active"),i.hide().css({top:0,opacity:0}),d.find("li.unread").removeClass("unread"),this.$current_user=null,this.isOpen=!1,!1},updateScrollbars:function(){scrollToBottom("#chat .chat-conversation .conversation-body")},updateConversationOffset:function(t){var n=i.find(".conversation-body").position().top+1,r=t.position().top-n,o=0,d=i.height(),h=a(s).height();e.hasClass("fixed")&&r+d>h&&(o=r+d-h),a(".page-container.horizontal-menu").length&&(o+=a(".page-container.horizontal-menu .navbar").height()),r-=o,i.transition({top:r,opacity:1})},getChatHistoryLength:function(){var a=parseInt(e.data("max-chat-history"),10);return(!a||a<1)&&(a=25),a},submitMessage:function(){var s=a.trim(h.val());if(h.val(""),this.isOpen&&this.$current_user){var t=this.$current_user.uniqueId().attr("id");this.pushMessage(t,s.replace(/<.*?>/g,""),e.data("current-user"),new Date),this.renderMessages(t)}},refreshUserIds:function(){a("#chat .chat-group a").each(function(s,t){var e=a(t),n=e.find(".user-status");e.uniqueId();var r=e.attr("id");if(void 0===neonChat.chat_history[r]){var i=e.data("status");if(!i)for(var s in neonChat.statuses)if(n.hasClass(neonChat.statuses[s].class)){i=s;break}neonChat.chat_history[r]={$el:e,messages:[],unreads:0,status:i}}})},pushMessage:function(a,s,t,e,n,r){if(a&&s){this.refreshUserIds();var i=this.getChatHistoryLength();this.chat_history[a].messages.length>=i&&(this.chat_history[a].messages=this.chat_history[a].messages.reverse().slice(0,i-1).reverse()),this.chat_history[a].messages.push({message:s,from:t,time:e,fromOpponent:n,unread:r}),r&&this.puffUnreadsAll(),this.puffUnreads()}},renderMessages:function(s,t){if(void 0!==this.chat_history[s]){for(var e in d.html(""),this.chat_history[s].messages){var n=this.chat_history[s].messages[e],r=a('<li><span class="user"></span><p></p><span class="time"></span></li>'),i=n.time,o=i;if("object"==typeof i){var h=((h=i.getHours())<10?"0":"")+h,u=((u=i.getMinutes())<10?"0":"")+u,c=i.getSeconds();c=(c<10?"0":"")+c,o=h+":"+u}r.find(".user").html(n.from),r.find("p").html(n.message.replace(/\n/g,"<br>")),r.find(".time").html(o),n.fromOpponent&&r.addClass("odd"),n.unread&&void 0===t&&(r.addClass("unread"),n.unread=!1),d.append(r)}this.updateScrollbars()}},getStatus:function(a){"object"==typeof a&&(a=a.attr("id"));var s=neonChat.chat_history[a];return s?s.status:null},setStatus:function(s,t){var e="string"==typeof s?a(".chat-group a#"+s.replace("#","")):s;if(e.$el&&(e=e.$el),e.length&&this.statuses[t].class){var n=e.find(".user-status");for(var r in this.statuses)n.removeClass(this.statuses[r].class);n.addClass(this.statuses[t].class),e.data("status",t),neonChat.chat_history[e.attr("id")].status=t,this.orderGroups()}},orderGroups:function(){var s=e.find(".chat-group");return!!e.data("order-by-status")&&(s.each(function(s,t){var e=a(t),n=e.find("> a");n.each(function(s,t){var e=a(t),n=e.find(".user-status");for(var s in neonChat.statuses){var r=neonChat.statuses[s];if(s==e.data("status"))return e.data("order-id",r.order),!0;if(n.hasClass(r.class))return e.data("order-id",r.order),!0}});n.sort(function(s,t){return parseInt(a(s).data("order-id"),10)>parseInt(a(t).data("order-id"),10)}).appendTo(e)}),!0)},prefetchMessages:function(){e.find(".chat-group a").each(function(s,t){var e=a(t),n=e.attr("id"),r=e.data("conversation-history");r&&r.length&&a(a(r)).find("> li").each(function(s,t){var e=a(t),r=e.find(".user").html(),i=e.find("p").html(),o=e.find(".time").html(),d=e.hasClass("even")||e.hasClass("odd")||e.hasClass("opponent"),h=e.hasClass("unread");neonChat.pushMessage(n,i,r,o,d,h)})})},countUnreadMessages:function(a){var s=0;if(a){if("object"==typeof a&&(a=a.attr("id")),t=neonChat.chat_history[a])return t.unreads}else for(var a in neonChat.chat_history){var t=neonChat.chat_history[a],e=0;for(var n in t.messages)t.messages[n].unread&&(s++,e++);t.unreads=e}return s},puffUnreads:function(){for(var a in this.chat_history){var s=neonChat.chat_history[a],t=s.$el.find(".badge");s.unreads>0?t.html(s.unreads).removeClass("is-hidden"):t.html(s.unreads).addClass("is-hidden")}},puffUnreadsAll:function(){var a=this.countUnreadMessages();r.html(a),r[a>0?"removeClass":"addClass"]("is-hidden")},resetUnreads:function(a){"object"==typeof a&&(a=a.attr("id"));var s=neonChat.chat_history[a];s&&(s.unreads=0,s.$el.find(".badge").html("0").addClass("is-hidden"))},createGroup:function(s,t){var n=a('<div class="chat-group"><strong>'+s+"</strong></div>");return t?n.insertBefore(e.find(".chat-group:first")):n.appendTo(e),n.hide().slideDown(),(n=n.uniqueId()).attr("id")},removeGroup:function(s,t){var n=e.find("#"+s.replace("#","")+".chat-group");if(n.length){if(t){var r=e.find("#"+t.replace("#","")+".chat-group");r.length&&n.find("a").each(function(s,t){var e=a(t);r.append(e),e.hide().slideDown()}),this.orderGroups()}n.slideUp(function(){n.remove()})}},addUser:function(s,t,n,r,i){var o=s;if("string"==typeof s&&(o=e.find("#"+s.replace("#","")+".chat-group")),o&&o.length){n=this.statuses[n];var d=a('<a href="#"><span class="user-status '+n.class+'"></span> <em>'+t+'</em> <span class="badge badge-info is-hidden>0</span></a>');return i&&d.attr("id",i),r?d.insertAfter(o.find("> strong")):d.appendTo(o),d.hide().slideDown(),this.refreshUserIds(),this.orderGroups(),d.uniqueId().attr("id")}return null},addUserId:function(a,s,t,e,n){return this.addUser(a,t,e,n,s)},getUser:function(a){return this.chat_history[a]?this.chat_history[a]:null},moveUser:function(a,s,t){var n=e.find("#"+s.replace("#","")+".chat-group"),r=this.chat_history[a];return!(!n.length||!r)&&(t?r.$el.insertAfter(n.find("> strong")):r.$el.appendTo(n),this.orderGroups(),!0)},showChat:function(a){var s="chat-visible";if(isxs()&&(s+=" toggle-click"),a){if(e.data("is-busy"))return!1;e.data("is-busy",!0),public_vars.$pageContainer.addClass(s);var t=parseInt(public_vars.$mainContent.css("padding-right"),10),n=parseInt(public_vars.$mainContent.css("padding-left"),10),r=e.width();public_vars.$pageContainer.removeClass(s),public_vars.$pageContainer.hasClass("right-sidebar")?public_vars.$mainContent.transition({paddingLeft:n,duration:500}):public_vars.$mainContent.transition({paddingRight:t,duration:500}),e.show(),TweenMax.set(e,{css:{autoAlpha:public_vars.$body.hasClass("boxed-layout")?0:1,transform:"translateX("+(public_vars.$pageContainer.hasClass("right-sidebar")?-1:1)*r+"px)"}}),TweenMax.to(e,.65,{css:{autoAlpha:1,transform:"translateX(0)"},ease:Sine.easeOut,onComplete:function(){public_vars.$pageContainer.addClass(s),public_vars.$mainContent.attr("style",""),TweenMax.set(e,{css:{transform:"",paddingRight:"",paddingLeft:""}}),e.data("is-busy",!1)}})}else public_vars.$pageContainer.addClass(s)},hideChat:function(a){var s="chat-visible";if(isxs()&&(s+=" toggle-click"),a){if(e.data("is-busy"))return!1;e.data("is-busy",!0),disableXOverflow(),public_vars.$pageContainer.removeClass(s);var t=parseInt(public_vars.$mainContent.css("padding-right"),10),n=parseInt(public_vars.$mainContent.css("padding-left"),10),r=e.width();public_vars.$pageContainer.addClass(s),neonChat.close(),TweenMax.to(e,.4,{css:{autoAlpha:public_vars.$body.hasClass("boxed-layout")?0:1,transform:"translateX("+(public_vars.$pageContainer.hasClass("right-sidebar")?-1:1)*r+"px)"},ease:Sine.easeIn});var i={paddingRight:t,duration:700,complete:function(){public_vars.$pageContainer.attr("style",""),public_vars.$mainContent.attr("style",""),e.attr("style",""),public_vars.$pageContainer.removeClass(s),enableXOverflow(),e.data("is-busy",!1)}};public_vars.$pageContainer.hasClass("right-sidebar")&&(delete i.paddingRight,i.paddingLeft=n),public_vars.$mainContent.transition(i)}else public_vars.$pageContainer.removeClass(s)},toggleChat:function(a,s){var t=public_vars.$pageContainer.hasClass("chat-visible")?"hideChat":"showChat";isxs()&&(t=public_vars.$pageContainer.hasClass("toggle-click")?"hideChat":"showChat"),neonChat[t](a),s&&u&&("hideChat"==t?show_sidebar_menu(a):hide_sidebar_menu(a))}}),d.on("click",function(){h.focus()}),neonChat.init()}(jQuery,window);